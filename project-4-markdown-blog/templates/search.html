{% extends "base.html" %}

{% block title %}Search - Markdown Blog{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-search"></i> Search Posts
            </h1>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Home
            </a>
        </div>

        <!-- Search Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="GET" action="{{ url_for('search') }}">
                    <div class="input-group input-group-lg">
                        <input type="search" class="form-control" name="q" 
                               placeholder="Search posts by title..." 
                               value="{{ query }}" required>
                        <button class="btn btn-primary" type="submit">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Search Results -->
        {% if query %}
            <div class="mb-3">
                <h5>Search Results for "{{ query }}"</h5>
                <p class="text-muted">{{ posts|length }} post(s) found</p>
            </div>
        {% endif %}

        {% if posts %}
            <div class="posts-container">
                {% for post in posts %}
                <div class="post-card mb-4">
                    <div class="card">
                        <!-- Post Header with Author -->
                        <div class="card-header bg-transparent border-0">
                            <div class="d-flex align-items-center">
                                <div class="avatar me-3">
                                    <i class="bi bi-person-circle fs-2 text-primary"></i>
                                </div>
                                <div class="post-meta">
                                    <h6 class="mb-0 fw-bold">{{ post.author }}</h6>
                                    <small class="text-muted">{{ post.filename|replace('.md', '')|replace('-', ' ') }}</small>
                                </div>
                                {% if session.is_admin %}
                                <div class="ms-auto">
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('edit_post', filename=post.filename) }}" class="btn btn-outline-secondary btn-sm">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <form method="POST" action="{{ url_for('delete_post', filename=post.filename) }}" style="display: inline;">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                    onclick="return confirm('Are you sure you want to delete this post?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% elif session.user_id and post.author == session.username %}
                                <div class="ms-auto">
                                    <div class="btn-group" role="group">
                                        <form method="POST" action="{{ url_for('delete_post', filename=post.filename) }}" style="display: inline;">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                    onclick="return confirm('Are you sure you want to delete your post?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Post Content -->
                        <div class="card-body">
                            <h5 class="card-title">{{ post.title }}</h5>
                            <p class="card-text">
                                {% if post.content %}
                                    {{ post.content[:200] }}{% if post.content|length > 200 %}...{% endif %}
                                {% else %}
                                    No content available.
                                {% endif %}
                            </p>
                        </div>
                        
                        <!-- Post Footer with Actions -->
                        <div class="card-footer bg-transparent border-0">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="post-actions">
                                    <a href="{{ url_for('post', filename=post.filename) }}" class="btn btn-primary btn-sm">
                                        <i class="bi bi-eye"></i> Read More
                                    </a>
                                </div>
                                
                                <!-- Like Button -->
                                {% if session.user_id %}
                                <div class="like-section">
                                    <button class="btn btn-outline-danger btn-sm like-btn" 
                                            data-post="{{ post.filename }}" 
                                            data-liked="{{ 'true' if post.user_liked else 'false' }}">
                                        <i class="bi bi-heart{% if post.user_liked %}-fill text-danger{% endif %}"></i>
                                        <span class="like-count">{{ post.like_count }}</span>
                                    </button>
                                </div>
                                {% else %}
                                <div class="like-section">
                                    <span class="text-muted">
                                        <i class="bi bi-heart"></i> {{ post.like_count }} likes
                                    </span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% elif query %}
            <div class="text-center py-5">
                <i class="bi bi-search display-1 text-muted"></i>
                <h3 class="mt-3">No Results Found</h3>
                <p class="text-muted mb-4">
                    No posts found matching "{{ query }}". Try different keywords or browse all posts.
                </p>
                <a href="{{ url_for('index') }}" class="btn btn-primary">
                    <i class="bi bi-house"></i> Browse All Posts
                </a>
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="bi bi-search display-1 text-muted"></i>
                <h3 class="mt-3">Search Posts</h3>
                <p class="text-muted mb-4">
                    Use the search box above to find posts by title.
                </p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Like functionality JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const likeButtons = document.querySelectorAll('.like-btn');
    
    likeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const postFilename = this.dataset.post;
            const isLiked = this.dataset.liked === 'true';
            
            fetch(`/like/${postFilename}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    console.error('Like error:', data.error);
                    alert('Error: ' + data.error);
                    return;
                }
                
                // Update button state
                const heartIcon = this.querySelector('i');
                const likeCount = this.querySelector('.like-count');
                
                if (data.liked) {
                    // Post was liked
                    this.dataset.liked = 'true';
                    heartIcon.className = 'bi bi-heart-fill text-danger';
                    likeCount.textContent = parseInt(likeCount.textContent) + 1;
                } else {
                    // Post was unliked
                    this.dataset.liked = 'false';
                    heartIcon.className = 'bi bi-heart';
                    likeCount.textContent = parseInt(likeCount.textContent) - 1;
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                alert('Network error: Unable to process like. Please try again.');
            });
        });
    });
});
</script>
{% endblock %}
